package main;

import main.Security.ISecurity;
import main.Stores.Store;
import main.Users.User;

import javax.naming.NoPermissionException;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicInteger;

public class Market {

    /**
     * usersByName is a hashmap that maps username -> User
     * each username is unique in the system
     *
     * connectedUsers is a hashmap that maps token -> connected user
     * once a user disconnects he's removed from this hashmap
     * the token is generated by the system, randomly
     */
    private ConcurrentHashMap<String, User> usersByName; //key=username
    private ConcurrentHashMap<String,User> connectedUsers; //key=userToken, generated randomly by system
    private ConcurrentHashMap<String, Store> stores; //key=store name
    private ISecurity security_controller;
    private AtomicInteger guestCounter;

    public Market(){
        usersByName=new ConcurrentHashMap<>();
        connectedUsers=new ConcurrentHashMap<>();
        stores=new ConcurrentHashMap<>();
        guestCounter=new AtomicInteger(1);
    }

    public boolean addProductToStore(String userToken, String productName, String category, List<String> keyWords, String description, String storeName, int quantity, double price) throws NoPermissionException {
        User user=connectedUsers.get(userToken);
        if(user==null)
            //user is offline/doesn't exist
            return false;

        Store store=stores.get(storeName);
        if(store==null)
            //no such store
            return false;

        return user.addProductToStore(store,productName,category,keyWords,description,quantity,price);
    }

    public boolean updateProductInStore(String userToken, String productName, String category, List<String> keyWords, String description, String storeName, int quantity, double price) throws NoPermissionException {
        User user = connectedUsers.get(userToken);
        if (user == null)
            return false;

        Store store = stores.get(storeName);
        if (store == null)
            return false;

        return user.updateProductToStore(store,productName,category,keyWords,description,quantity,price);

    }


}


